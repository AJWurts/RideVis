<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-array.v2.min.js"></script>
<link href='./style.css' rel='stylesheet'>
</link>
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="https://svadivazhagu.github.io/PyLeague/d3.css">

<body>
    <div>
        <!-- <ul id="totals">
            <li  class='totals-list'>
                <strong>606.3<abbr class="unit" title="miles">mi</abbr></strong>
            </li>
            <li  class='totals-list'>
                <strong>35<abbr class="unit" title="hour">h</abbr> 23<abbr class="unit" title="minute">m</abbr></strong>
            </li>
            <li   class='totals-list'>
                <strong>21,645<abbr class="unit" title="feet">ft</abbr></strong>
            </li>
        </ul> -->
        <svg id='vis'></svg></br>
        <div style="display: inline-block;  margin: 0px 0px 0px 150px; width: 50%">
            <button onclick=onTimeClick() class='custom-buttom'>
                Time
            </button class='custom-buttom'>
            <button onclick=onDistanceClick() class='custom-buttom'>
                Distance
            </button>
            <button onclick=onElevationClick() class='custom-buttom'>
                Elevation
            </button>
            <button onclick=onWeeklyClick() class='custom-buttom' style="margin: 0px 0px 0px 50px">
                Weekly
            </button>
            <button onclick=onMonthlyClick() class='custom-buttom'>
                Monthly
            </button>
        </div>

    </div>


</body>

<script>
    var width = 750
    var height = 250
    var svg = d3.select('body').select('#vis')
        .attr('width', width + 300)
        .attr('height', height)

    var fontFamily = '-apple-system, system-ui, BlinkMacSystemFont, Roboto, "Segoe UI", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"'

    // Want data for all of 2018 :D
    var xScale = d3.scaleLinear()
        .range([width * 0.1, width])

    var timeScale = d3.scaleTime()
        .domain([new Date(2018, 0, 1), new Date(2018, 11, 31)])
        .range([width * 0.1, width]);

    var yScale = d3.scaleLinear()
        .range([height * 0.8, height * 0.2])


    const goals = {
        distance: {
            weekly: 150,
            monthly: 450
        },
        elevation: {
            weekly: 5000,
            monthly: 20000
        },
        time: {
            weekly: 25200,
            monthly: 25200 * 4
        }
    }


    var options = {
        time: 'monthly',
        units: 'distance'
    }


    var monthly = [];






    // Top of graph labels on hover
    svg.append('text')
        .style('font-family', fontFamily)
        .attr('id', 'distance-label')
        .attr('y', height * 0.1)
        .attr('x', width / 2 - 75)

    svg.append('text')
        .style('font-family', fontFamily)

        .attr('id', 'time-label')
        .attr('y', height * 0.1)
        .attr('x', width / 2)

    svg.append('text')
        .attr('id', 'elevation-label')
        .style('font-family', fontFamily)
        .attr('y', height * 0.1)
        .attr('x', width / 2 + 75)

    function onElevationClick() {
        console.log("Monthly")
        options.units = 'elevation';
        drawGraph();
    }

    function onDistanceClick() {
        console.log("Weekly")
        options.units = 'distance';
        drawGraph();
    }

    function onTimeClick() {
        console.log("Weekly")
        options.units = 'time';
        drawGraph();
    }

    function onMonthlyClick() {
        console.log("Monthly")

        options.time = 'monthly';
        drawGraph();
    }

    function onWeeklyClick() {
        console.log("Weekly")
        options.time = 'weekly';
        drawGraph();
    }

    function getYScaled(d) {
        if (options.units === 'distance') {
            return yScale(d.distance);
        } else if (options.units === 'time') {
            return yScale(d.elapsed_time);
        } else if (options.units === 'elevation') {
            return yScale(d.total_elevation_gain);
        }
    }

    function getY(d) {
        if (options.units === 'distance') {
            return d.distance
        } else if (options.units === 'time') {
            return d.elapsed_time
        } else if (options.units === 'elevation') {
            return d.total_elevation_gain
        }
    }

    function getData() {
        if (options.time === 'monthly') {
            return monthly;
        } else {
            return weekly;
        }
    }

    function getUnits() {
        if (options.units === 'distance') {
            return 'miles';
        } else if (options.units === 'time') {
            return 'hours'
        } else if (options.units === 'elevation') {
            return 'ft'
        }
    }

    function drawGraph() {
        var data = getData().filter(d => d.year === 2017)
        console.log(data)
        let maxVal = d3.max(data, x => getY(x))
        console.log(maxVal)
        yScale.domain([0, Math.max(maxVal, goals[options.units][options.time]) + 100])
        xScale.domain([0, options.time === 'monthly' ? 12 : 52])
        data = data.sort((a, b) => options.time === 'monthly' ? a.month - b.month : a.weekNumber - b.weekNumber)

        d3.selectAll('.delete').remove()

        var yAxis = d3.axisLeft(yScale)
            .ticks(10)

        if (options.units === 'time') {
            yAxis.tickFormat(d => (d / 3600).toFixed(0))
        }

        var xAxis = d3.axisBottom(timeScale)
            .tickFormat(d3.timeFormat("%b"));


        // Y Axis Label
        svg.append("text")
            .attr('class', 'delete')
            .style('font-family', fontFamily)
            .attr("x", width * 0.05)
            .attr("y", height * 0.81)
            .attr('font-size', 12)
            .style("text-anchor", "middle")
            .attr('fill', 'black')
            .text(getUnits);

        svg.append('g')
            .attr("transform", "translate(0," + (height * 0.8) + ")")
            .attr('class', 'delete')
            .call(xAxis)


        svg.append('g')
            .attr('transform', "translate(" + (width * 0.1) + ",0)")
            .attr('class', 'delete')
            .call(yAxis)


        svg.selectAll('dataBars')
            .data(data)
            .enter()
            .append('rect')
            .attr('class', d => {
                var className = 'delete month' + d.month.toFixed(0) + " year" + d.year;
                if (options.time === 'weekly') {
                    className += ' weekNumber' + d.weekNumber;
                }
                return className;
            })
            .attr('y', d => height * 0.8)
            .attr('x', d => {
                if (options.time === 'monthly') {
                    return xScale(d.month);
                } else {
                    return xScale(d.weekNumber);
                }

            })
            .attr('width', d => {
                if (options.time === 'weekly') {
                    return (width * 0.9) / 52 - 3
                }
                return (width * 0.9) / 12 - 3
            })
            .attr('height', 0)
            .style("fill", "url(#linear-gradient)")
            .transition()
            .duration(500)
            .attr('y', getYScaled)
            .attr('height', d => height * 0.8 - getYScaled(d))


        svg.selectAll('selectionBars')
            .data(data)
            .enter()
            .append('rect')
            .attr('class', 'delete')
            .attr('x', d => {
                if (options.time === 'monthly') {
                    return xScale(d.month);
                } else {
                    return xScale(d.weekNumber);
                }
            })
            .attr('y', d => height * 0.2)
            .attr('width', d => {
                if (options.time === 'weekly') {
                    return (width * 0.9) / 52 - 3
                }
                return (width * 0.9) / 12 - 3
            })
            .attr('height', height * 0.6)
            .attr('fill', '#00000000')
            .on('mouseover', onBarHover)
            .on('mouseout', onBarOut)


        addLineWithLabel(maxVal, 'Max', '#000000DD')
        addLineWithLabel(goals[options.units][options.time], 'Goal', '#000000DD')
    }

    function formatVal(val) {
        if (options.units === 'elevation') {
            return numberWithCommas(val.toFixed(0)) + 'ft'
        } else if (options.units === 'distance') {
            return val.toFixed(0) + 'mi'
        } else {
            var hours = Math.floor(val / 3600)
            var minutes = Math.floor((val - hours * 3600) / 60)
            return hours + 'h ' + minutes + 'm';
        }
    }

    function addLineWithLabel(val, label, color) {
        console.log(val, label, color);
        // Goal Dist Line
        svg.append('line')
            .attr('x1', width * 0.1)
            .attr('y1', yScale(val))
            .attr('x2', width)
            .attr('y2', yScale(val))
            .attr('class', 'delete')
            .attr('stroke', color || 'black')
            .style("stroke-dasharray", ("3, 3"))  // <== This line here!!
            .attr('stroke-width', 3)

        svg.append('text')
            .attr('x', width + 5)
            .attr('y', yScale(val) + 4)
            .attr('class', 'delete')
            .style('font-family', fontFamily)
            .text(label + ': ' + formatVal(val))
    }

    function numberWithCommas(x) {
        var parts = x.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    }

    function onBarHover(d) {
        if (options.time === 'monthly') {
            var comp = d3.selectAll('.year' + d.year).filter(" .month" + d.month.toFixed(0))

        } else {
            var comp = d3.selectAll('.year' + d.year).filter(" .month" + d.month.toFixed(0)).filter(' .weekNumber' + d.weekNumber)
        }
        comp.style('fill', '#00c0E0')

        d3.select('#distance-label')
            .text(d.distance.toFixed(1) + 'mi');

        var hours = Math.floor(d.elapsed_time / 3600)
        var minutes = Math.floor((d.elapsed_time - hours * 3600) / 60)
        d3.select('#time-label')
            .text(hours + 'h ' + minutes + 'm');

        d3.select('#elevation-label')
            .text(numberWithCommas(d.total_elevation_gain.toFixed(0)) + 'ft');

    }

    function onBarOut(d) {
        d3.selectAll('.year' + d.year).filter(" .month" + d.month.toFixed(0))
            .style("fill", "url(#linear-gradient)")
    }

    //linear-gradient(#009CE0, #0070A0);
    var colorRange = ['#009CE0', '#0070A0']

    var color = d3.scaleLinear().range(colorRange).domain([1, 2]);

    var linearGradient = svg.append("defs")
        .append("linearGradient")
        .attr("id", "linear-gradient")
        .attr("gradientTransform", "rotate(90)");


    linearGradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", color(1));

    linearGradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", color(2));




    d3.json("https://ajwurts.github.io/datavis_4/rides_by_month.json")
        .then(result => {
            console.log(result)
            monthly = result;
            // result = result.filter(d => d.year === 2017)

            // let maxDist = d3.max(result, x => x.distance)
            // console.log(maxDist)
            // yScale.domain([0, Math.max(maxDist, distanceGoal) + 100])

            // result = result.sort((a, b) => a.month - b.month)

            // var yAxis = d3.axisLeft(yScale)
            //     .ticks(10)

            // var xAxis = d3.axisBottom(timeScale)
            //     .tickFormat(d3.timeFormat("%b"));

            // svg.append('g')
            //     .attr("transform", "translate(0," + (height * 0.8) + ")")
            //     .call(xAxis)


            // svg.append('g')
            //     .attr('transform', "translate(" + (width * 0.1) + ",0)")
            //     .call(yAxis)


            // svg.selectAll('dataBars')
            //     .data(result)
            //     .enter()
            //     .append('rect')
            //     .attr('class', d => 'month' + d.month + " year" + d.year)
            //     .attr('y', d => height * 0.8)
            //     .attr('x', d => xScale(d.month))
            //     .attr('width', (width * 0.9) / 12 - 3)
            //     .attr('height', 0)
            //     .style("fill", "url(#linear-gradient)")
            //     .transition()
            //     .duration(500)
            //     .attr('y', d => yScale(d.distance))
            //     .attr('height', d => height * 0.8 - yScale(d.distance))



            // svg.selectAll('selectionBars')
            //     .data(result)
            //     .enter()
            //     .append('rect')
            //     .attr('x', d => xScale(d.month))
            //     .attr('y', d => height * 0.2)
            //     .attr('width', (width * 0.9) / 12 - 3)
            //     .attr('height', height * 0.6)
            //     .attr('fill', '#00000000')
            //     .on('mouseover', onBarHover)
            //     .on('mouseout', onBarOut)


            // addLineWithLabel(maxDist, 'Max Dist', '#000000DD')
            // addLineWithLabel(distanceGoal, 'Goal', '#000000DD')
            drawGraph()
        })


    d3.json("https://ajwurts.github.io/datavis_4/rides_by_week.json")
        .then(result => {
            weekly = result;
        })
</script>